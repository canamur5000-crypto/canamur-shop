
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique Canamur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #ffffff;
        }
        .container-main {
            padding-bottom: 8rem;
            position: relative;
            z-index: 10;
        }
        .hero-section {
            background-image: url('https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/1757022565259.jpg');
            background-size: cover;
            background-position: center;
            height: 250px;
            position: relative;
        }
        .nav-bar {
            background-color: rgba(33, 33, 53, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 400px;
            z-index: 50;
        }
        .nav-link {
            color: #d1d5db;
            transition: color 0.2s, transform 0.1s; 
        }
        .nav-link.active {
            color: #7b4397;
        }
         .nav-link:active { 
             transform: scale(0.95);
             color: #7b4397; 
        }
        .product-card {
            background-color: #2a2a47; 
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .product-card:active {
            transform: scale(0.97); 
        }
        
        .category-pill {
            background-color: rgba(63, 63, 90, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.35rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s; 
            font-size: 0.875rem;
        }
        .category-pill:hover,
        .category-pill.active {
            background-color: rgba(93, 93, 129, 0.5);
        }
        .category-pill:active {
            transform: scale(0.95); 
        }
        .carousel-container { 
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem; 
            width: 100%;
            height: auto;
        }
        .carousel-slide {
            display: flex;
            transition: transform 0.5s ease-in-out;
            width: 100%;
            height: 100%; 
            touch-action: pan-y;
        }
        .carousel-item {
            flex-shrink: 0;
            width: 100%;
            height: 100%; 
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .carousel-item img, .carousel-item iframe, .carousel-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .carousel-button { 
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 20;
            border-radius: 9999px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        .carousel-button:hover {
            opacity: 1;
        }
        .carousel-button.left {
            left: 10px;
        }
        .carousel-button.right {
            right: 10px;
        }
        .buy-button {
            background-color: #7b4397;
            color: #ffffff;
            transition: background-color 0.2s;
        }
        .buy-button:hover {
            background-color: #5c3272;
        }
        .add-to-cart-button {
            background-color: #4b5563;
            color: #ffffff;
            transition: background-color 0.2s;
        }
        .add-to-cart-button:hover {
            background-color: #374151;
        }
        .modal {
            background-color: #1a1a2e;
            border-radius: 12px;
        }
        .cart-item {
            border-bottom: 1px solid #3f3f5a;
        }
        .site-title {
            background-image: url('https://canamur5000-crypto.github.io/canamur-shop/Picsart_25-09-04_15-14-29-640.jpg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            height: 50px;
            width: 100%;
            text-indent: -9999px;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .separator {
            width: 50%;
            height: 1px;
            background-color: #3f3f5a;
            margin: 1rem auto;
        }
        .potato-icon {
            font-size: 24px;
            color: #fff;
            background-image: url('https://canamur5000-crypto.github.io/canamur-shop/Picsart_25-05-16_23-24-53-435.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 24px;
            height: 24px;
            text-indent: -9999px;
            overflow: hidden;
        }
        
        .product-page-background {
            background-image: url('https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/1000021428.jpg');
            background-size: cover;
            background-position: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            filter: blur(10px);
            z-index: 1;
        }
        .product-page-content {
            position: relative;
            z-index: 10;
            padding-bottom: 8rem;
        }

        .action-button {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            transition: transform 0.1s; 
        }

        .action-button:active {
            transform: scale(0.97); 
        }

        .order-button {
            background-color: #4c68ff;
            color: #ffffff;
        }
        .add-to-cart-button-new {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        /* Styles de la page du panier */
        .cart-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a2e;
            z-index: 50;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            padding-bottom: 6rem;
        }
        .cart-page.open {
            transform: translateX(0);
        }
        .cart-page-header {
            background-color: #1a1a2e;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cart-page-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cart-page-total {
            background-color: #1a1a2e;
            padding: 1rem;
            position: sticky;
            bottom: 0;
            z-index: 20;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Styles de la page produit */
        .product-page-image-container { 
            width: 100%;
            height: 60vh;
            overflow: hidden;
            position: relative;
            background-color: #2a2a47; 
            border-radius: 0.75rem;
        }

        .product-page-image-container img,
        .product-page-image-container iframe,
        .product-page-image-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            border-radius: 0.75rem;
        }
        
        .carousel-item video {
            display: block;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: #2a2a47;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 80%;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .product-page-content {
            padding-bottom: 8rem;
        }
        
        .weight-button {
            background-color: #3f3f5a;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: #ffffff;
            transition: background-color 0.2s, transform 0.1s; 
            text-align: center;
        }
        .weight-button:active {
            transform: scale(0.95); 
        }
        .weight-button.active {
            background-color: #7b4397;
            transform: scale(1.05);
        }
        .weight-button span {
            display: block;
        }
        .weight-button .weight-text {
            font-size: 0.875rem;
            font-weight: bold;
        }
        .weight-button .price-text {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Styles pour les boutons de la barre de navigation */
        .nav-link:active {
            transform: scale(0.95);
            color: #7b4397; 
        }

        /* Styles pour les boutons de la page produit (variété) */
        .variety-btn {
            transition: transform 0.1s, background-color 0.2s, border-color 0.2s; 
            border: 1px solid #4a5568; 
            color: #cbd5e1;
        }
         .variety-btn:hover {
            background-color: #4a5568; 
         }
         .variety-btn.active { 
             background-color: #6d28d9; 
             border-color: #8b5cf6; 
             color: white;
         }
        .variety-btn:active {
            transform: scale(0.95);
        }
         /* Style pour les points du carrousel d'accueil */
        #hero-carousel-dots span {
             cursor: pointer;
             transition: background-color 0.3s, transform 0.2s;
             width: 0.5rem; 
             height: 0.5rem; 
             border-radius: 9999px; 
        }
         #hero-carousel-dots span.active {
             background-color: white;
             transform: scale(1.25); 
         }
         #hero-carousel-dots span:not(.active) {
             background-color: #6b7280; 
         }
         #hero-carousel-dots span:not(.active):hover {
            background-color: #d1d5db; 
             transform: scale(1.1);
         }
         
         #hero-carousel-track .carousel-item {
             height: auto; 
         }
         #hero-carousel-track .carousel-item img,
         #hero-carousel-track .carousel-item video {
             height: auto; 
             width: 100%;
             object-fit: cover; 
             border-radius: 0.75rem; 
         }
    </style>
</head>
<body class="bg-[#1A1A2E] text-white">

    <!-- Section principale de l'application -->
    <div id="main-app" class="container-main mx-auto p-4 max-w-sm overflow-hidden pb-32">
        <!-- Bannière Héro -->
        <header class="flex flex-col items-center justify-center p-8">
            <div id="hero-carousel-container" class="relative w-full h-auto bg-gray-700 rounded-xl overflow-hidden shadow-lg">
                <div id="hero-carousel-track" class="carousel-slide w-full h-full">
                    <!-- Les images du carrousel d'accueil seront injectées ici -->
                </div>
                <div id="hero-carousel-dots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                    <!-- Les points de navigation du carrousel seront injectés ici -->
                </div>
            </div>
        </header>

        <div class="separator"></div>
        
        <!-- Section des catégories -->
        <section class="py-8">
            <h2 class="text-xl font-bold mb-4 text-center">Catégorie</h2>
            <div class="flex justify-center space-x-4">
                <span id="weed-pill" class="category-pill" onclick="toggleFilter('weed')">WEED</span>
                <span id="hash-pill" class="category-pill" onclick="toggleFilter('hash')">HASH</span>
            </div>
        </section>

        <!-- Ligne de séparation -->
        <div class="separator"></div>

        <!-- Grille des produits -->
        <section id="product-grid" class="pt-4">
            <!-- Les cartes de produits seront générées dynamiquement ici -->
        </section>
    </div>

    <!-- Section Fiche Produit (cachée par défaut) -->
    <div id="product-page" class="hidden relative">
        <div class="product-page-content mx-auto p-4 max-w-sm overflow-hidden pb-32">
            <header class="p-4 bg-transparent text-white flex justify-between items-center sticky top-0 z-50">
                <button onclick="window.hideProduct()" class="text-white text-2xl p-2 rounded-full hover:bg-gray-800 transition-colors active:scale-90"><i class="fas fa-arrow-left"></i></button>
                <h1 id="product-category" class="text-xl font-semibold uppercase"></h1>
            </header>
            <div class="product-page-image-container rounded-xl shadow-lg mb-4">
                <div id="carousel-track" class="carousel-slide">
                    <!-- Les images/videos de toutes les variétés seront injectées ici -->
                </div>
                <button class="carousel-button left" onclick="window.prevSlide()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button class="carousel-button right" onclick="window.nextSlide()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>

            <div class="p-4 mx-auto max-w-md">
                <h2 id="product-name" class="text-2xl font-bold mt-4 mb-2"></h2>
                
                <div id="product-options" class="mb-6">
                    <!-- Les options de variété et de poids seront injectées ici -->
                </div>

                <div class="flex flex-col space-y-4">
                    <button id="buy-now-btn" class="action-button order-button">
                        <i class="fab fa-telegram-plane"></i>
                        <span class="ml-2">COMMANDER</span>
                    </button>
                    <button id="add-to-cart-btn" class="action-button add-to-cart-button-new">AJOUTER AU PANIER</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Page du panier (cachée par défaut) -->
    <div id="cart-page" class="cart-page">
        <div class="cart-page-header flex justify-between items-center">
            <button onclick="window.closeCartPage()" class="text-white text-2xl p-2 rounded-full hover:bg-gray-800 transition-colors active:scale-90"><i class="fas fa-arrow-left"></i></button>
            <h1 class="text-2xl font-bold">Mon Panier</h1>
            <button onclick="window.clearCart()" class="text-gray-400 hover:text-white transition-colors active:scale-90"><i class="fas fa-trash-alt"></i></button>
        </div>
        <div id="cart-items-page" class="flex-grow p-4">
            <!-- Les articles du panier seront injectés ici -->
        </div>
        <div class="cart-page-total flex justify-between items-center px-4 py-6 border-t border-gray-600 rounded-lg shadow-lg">
            <div class="text-xl font-bold">Total: <span id="cart-total-page">0€</span></div>
            <button onclick="placeOrder()" class="buy-button py-3 px-6 rounded-lg text-lg font-bold active:scale-[0.97]">
                <i class="fab fa-telegram-plane"></i>
                <span class="ml-2">COMMANDER</span>
            </button>
        </div>
    </div>

    <!-- Modal pour les messages -->
    <div id="message-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modal-text" class="text-lg font-bold mb-4"></p>
            <button onclick="window.closeModal()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full active:scale-95">OK</button>
        </div>
    </div>

    <!-- Ligne de séparation avant la navigation -->
    <div class="separator"></div>

    <!-- Barre de navigation en bas -->
     <nav class="nav-bar fixed bottom-4 flex justify-around items-center h-16 shadow-lg">
         
        <a href="#" onclick="window.showHome()" class="nav-link flex flex-col items-center">
            <i class="fas fa-home text-xl"></i>
            <span class="text-xs mt-1">Accueil</span>
        </a>
      
        <a href="https://www.instagram.com/canamur5k?igsh=MXdxYjZ6dm1yOGky" target="_blank" class="nav-link flex flex-col items-center">
            <i class="fab fa-instagram text-xl"></i>
            <span class="text-xs mt-1">Instagram</span>
        </a>
          
        <a href="https://ptwdym158.org/DailyHash" target="_blank" class="nav-link flex flex-col items-center">
            <i class="fas fa-link text-xl"></i>
            <span class="text-xs mt-1">Potato</span>
        </a>
          
        <a href="https://t.me/Dailyhash" target="_blank" class="nav-link flex flex-col items-center">
            <i class="fab fa-telegram text-xl"></i>
            <span class="text-xs mt-1">Telegram</span>
        </a>
          
        <a href="#" onclick="window.openCartPage()" class="nav-link relative flex flex-col items-center">
            <i class="fas fa-shopping-basket text-xl"></i>
            <span class="text-xs mt-1">Panier</span>
            <span id="cart-counter" class="absolute top-0 right-2 bg-red-500 rounded-full text-xs font-bold w-5 h-5 flex items-center justify-center -mt-2" style="display: none;">0</span>
        </a>
      
     </nav>

    <!-- Scripts JavaScript -->
    <script>
        // #############################################################
        // # DÉBUT DE L'INJECTION DE DONNÉES
        // #############################################################
        const products = {
    "caliLoose": {
        "id": "caliLoose",
        "name": "Cali US Loose",
        "prices": {
            "3.5g": 45,
            "5g": 60,
            "10g": 110,
            "12.5g": 130,
            "25g": 225
        },
        "category": "weed",
        "varieties": [
            "Weeding Cake",
            "Candy gelato"
        ],
        "images": [
            "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/preview.png"
        ],
        "mediaMap": {
            "Weeding Cake": [
                "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/weedingcake.mp4"
            ],
            "Candy gelato": [
                "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/Candy%20gelato.mp4"
            ]
        },
        "extraInfo": "FULL TERPS ",
        "extraInfoColor": "#d6d0e7",
        "extraInfoBackgroundColor": "#1bb625",
        "color": "#ffffff",
        "cardColor": "#2a2a47"
    },
    "frozenSift": {
        "id": "frozenSift",
        "name": "Frozen Sift Streetfarmz",
        "prices": {
            "3.5g": 60,
            "5g": 85,
            "10g": 150,
            "12.5g": 175,
            "25g": 320
        },
        "category": "hash",
        "varieties": [
            "Trap Grape",
            "Trop Cherry X Gazmint",
            "Weeding Cake"
        ],
        "images": [
            "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/Screenshot_20251012_222246_Chrome.jpg"
        ],
        "mediaMap": {
            "Trap Grape": [
                "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/Screenshot_20251012_222246_Chrome.jpg",
                "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/vluggejapieterpz-20251012-0001.mp4"
            ],
            "Trop Cherry X Gazmint": [
                "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/Screenshot_20251012_222246_Chrome.jpg",
                "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/vluggejapieterpz-20251012-0001.mp4"
            ],
            "Weeding Cake": [
                "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/Screenshot_20251012_222246_Chrome.jpg",
                "https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/vluggejapieterpz-20251012-0001.mp4"
            ]
        },
        "extraInfo": "NEW SEASON",
        "extraInfoColor": "#34d399",
        "extraInfoBackgroundColor": "#000000",
        "color": "#ffffff",
        "cardColor": "#2a2a47"
    }
};
        const heroImages = ["https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/1757022565259.jpg","https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/1758993410955.jpg","https://raw.githubusercontent.com/canamur5000-crypto/canamur-shop/main/1758993497780.jpg"];
        // #############################################################
        // # FIN DE L'INJECTION DE DONNÉES
        // #############################################################
        
        let cartItems = JSON.parse(localStorage.getItem('cartItems')) || {};
        let currentFilter = null;
        let currentProduct = null;
        let selectedVariety = null;
        let selectedWeight = null;
        let currentSlide = 0; // Pour carrousel page produit
        let startX = 0;
        let endX = 0;
        let heroSlideIndex = 0; // Pour carrousel accueil
        let heroCarouselInterval;

        // --- Sélecteurs DOM ---
        const mainApp = document.getElementById('main-app');
        const productPage = document.getElementById('product-page');
        const cartPage = document.getElementById('cart-page');
        const cartCounter = document.getElementById('cart-counter');
        const productName = document.getElementById('product-name');
        const productOptions = document.getElementById('product-options');
        const carouselTrack = document.getElementById('carousel-track'); // Page produit
        const buyNowBtn = document.getElementById('buy-now-btn');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const productGrid = document.getElementById('product-grid');
        const productCategoryTitle = document.getElementById('product-category');
        const heroCarouselTrack = document.getElementById('hero-carousel-track'); // Accueil
        const heroCarouselDots = document.getElementById('hero-carousel-dots'); // Accueil

        // --- Carrousel d'Accueil (JS CORRIGÉ) ---
         function updateHeroCarousel() {
             if (!heroCarouselTrack || !heroCarouselDots) return; 

             heroCarouselTrack.innerHTML = '';
             heroCarouselDots.innerHTML = '';
             (heroImages || []).forEach((url, index) => { 
                 const item = document.createElement('div');
                 item.className = 'carousel-item';
                 
                 let content;
                 if (url.toLowerCase().includes('.mp4')) { 
                   content = `<video autoplay controls playsinline loop muted class="w-full h-full object-cover"><source src="${url}" type="video/mp4">Vidéo non supportée.</video>`;
                 } else {
                   content = `<img src="${url}" alt="Image d'accueil ${index + 1}" class="w-full h-full object-cover" onerror="this.parentElement.style.display='none';">`;
                 }
                 item.innerHTML = content;
                 
                 heroCarouselTrack.appendChild(item);

                 const dot = document.createElement('span');
                 dot.setAttribute('data-index', index);
                 dot.onclick = () => goToHeroSlide(index); 
                 dot.className = index === heroSlideIndex ? 'active' : ''; 
                 heroCarouselDots.appendChild(dot);
             });
             heroCarouselDots.style.display = (heroImages && heroImages.length > 1) ? 'flex' : 'none';
             if (heroCarouselTrack) { 
                heroCarouselTrack.style.transform = `translateX(-${heroSlideIndex * 100}%)`;
             }
        }

        function goToHeroSlide(index) {
             if (index === heroSlideIndex) return;
             heroSlideIndex = index;
             updateHeroCarousel();
             startHeroCarousel(); // Redémarre le timer
        }

        function startHeroCarousel() {
            if (heroCarouselInterval) clearInterval(heroCarouselInterval);
            if (heroImages && heroImages.length > 1) {
                heroCarouselInterval = setInterval(() => {
                    heroSlideIndex = (heroSlideIndex + 1) % heroImages.length;
                    updateHeroCarousel();
                }, 4000); // 4 secondes
            }
        }
        // --- Fin Carrousel d'Accueil ---


        // --- Gestion Panier ---
        function saveCart() { localStorage.setItem('cartItems', JSON.stringify(cartItems)); updateCartCounter(); }
        function updateCartCounter() { 
            let count = 0; 
            for (const itemId in cartItems) count += cartItems[itemId].quantity; 
            if (cartCounter) { 
                cartCounter.textContent = count;
                cartCounter.style.display = count > 0 ? 'flex' : 'none';
            }
        }

        // --- Grille Produits (Logique de génération depuis le JS du template) ---
        function initProductGrid() {
             if (!productGrid) return;
             productGrid.innerHTML = '';
            const allProducts = Object.values(products || {}); // Sécurité
            const displayedProducts = currentFilter ? allProducts.filter(p => p.category === currentFilter) : allProducts;
            productGrid.className = displayedProducts.length === 1 ? 'flex justify-center pt-4' : 'grid grid-cols-2 gap-4 pt-4'; // Rétabli gap-4
            if (displayedProducts.length === 0) { productGrid.innerHTML = '<p class="text-center text-gray-400 col-span-full py-10">Restock en cours...</p>'; }
            else {
                displayedProducts.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card cursor-pointer active:scale-[0.97]';
                    card.style.backgroundColor = product.cardColor || '#2a2a47'; // Applique couleur cadre
                    if (displayedProducts.length === 1) card.classList.add('w-full', 'max-w-xs');
                    card.onclick = () => showProduct(product.id);
                    
                    let imageUrl = (product.images && product.images.length > 0) ? product.images[0] : 'https://placehold.co/600x600/1e293b/fff?text=Image+Produit';
                    
                    let extraInfo = '';
                    if (product.extraInfo) {
                         const infoTextColor = product.extraInfoColor || '#34d399'; // Applique couleur texte info
                         const infoBgColor = product.extraInfoBackgroundColor || '#000000'; // NOUVEAU
                         extraInfo += `<p class="text-xs font-bold mt-1"><span class="px-2 py-0.5 rounded-full inline-block" style="color: ${infoTextColor}; background-color: ${infoBgColor};">${product.extraInfo.toUpperCase()}</span></p>`;
                    } else if (product.varieties && product.varieties.length > 1 && !(product.varieties.length === 1 && product.varieties[0] === product.name)) {
                         extraInfo += `<p class="text-xs font-bold mt-1"><span class="bg-purple-900/50 px-2 py-0.5 rounded-full inline-block text-purple-300">${product.varieties.length} VARIÉTÉS</span></p>`;
                    }

                    const titleColor = product.color || '#ffffff'; // Applique couleur titre
                    
                    card.innerHTML = `
                        <img src="${imageUrl}" alt="${product.name}" class="w-full h-32 object-cover rounded-t-xl" onerror="this.src='https://placehold.co/600x400/2a2a47/fff?text=Img'; this.onerror=null;">
                        <div class="p-2">
                            <h3 class="font-bold text-sm" style="color: ${titleColor};">${product.name}</h3>
                            <p class="text-gray-400 text-xs">${product.prices ? `À partir de ${Object.values(product.prices)[0]}€` : 'Prix non défini'}</p>
                            ${extraInfo}
                        </div>
                    `;
                    productGrid.appendChild(card);
                });
            }
        }
        window.toggleFilter = function(category) {
            const pills = ['weed-pill', 'hash-pill'];
            if (currentFilter === category) { currentFilter = null; pills.forEach(id => document.getElementById(id)?.classList.remove('active')); } 
            else { currentFilter = category; pills.forEach(id => document.getElementById(id)?.classList.remove('active')); document.getElementById(`${category}-pill`)?.classList.add('active'); } 
            initProductGrid();
         };


        // --- Carrousel Page Produit ---
        function pauseAllVideos() { carouselTrack?.querySelectorAll('video').forEach(video => { if (!video.paused) video.pause(); }); } 
        function playCurrentVideo() {
            const currentItem = carouselTrack?.children[currentSlide]; 
            if (currentItem) { const video = currentItem.querySelector('video'); if (video) { video.currentTime = 0; video.play().catch(e => console.log('Autoplay blocked:', e)); } }
         }
        function updateCarousel() { 
            const totalSlides = carouselTrack?.children.length || 0; 
            if (totalSlides > 0) { 
                carouselTrack.style.transform = `translateX(-${currentSlide * 100}%)`; 
                pauseAllVideos(); 
                playCurrentVideo(); 
                
                // --- LOGIQUE INVERSÉE (Slide change -> Bouton sélectionné) ---
                const currentSlideElement = carouselTrack.children[currentSlide];
                if (currentSlideElement) {
                    const slideVariety = currentSlideElement.getAttribute('data-variety');
                    if (slideVariety && slideVariety !== selectedVariety) {
                        // Appelle selectVariety SANS événement pour juste mettre à jour le UI
                        window.selectVariety(slideVariety, null); 
                    }
                }
            } 
        } 
        window.nextSlide = function() { const total = carouselTrack?.children.length || 0; if (total > 1) { currentSlide = (currentSlide + 1) % total; updateCarousel(); } } 
        window.prevSlide = function() { const total = carouselTrack?.children.length || 0; if (total > 1) { currentSlide = (currentSlide - 1 + total) % total; updateCarousel(); } } 
        if (carouselTrack) {
            carouselTrack.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; pauseAllVideos(); }, { passive: true });
            carouselTrack.addEventListener('touchend', (e) => { endX = e.changedTouches[0].clientX; const diffX = endX - startX; if (diffX > 50) window.prevSlide(); else if (diffX < -50) window.nextSlide(); else playCurrentVideo(); });
        }


        // --- Modal ---
        function showMessage(message) { 
            const modal = document.getElementById('message-modal');
            const modalText = document.getElementById('modal-text');
            if (modalText) modalText.textContent = message;
            if (modal) modal.classList.remove('hidden');
        }
        window.closeModal = function() { document.getElementById('message-modal')?.classList.add('hidden'); } // Ajout ?.

        // --- Logique Page Produit (JS Corrigé pour .active) ---
        function updateProductCarousel(product, varietyToHighlight) {
             if (!carouselTrack) return; 
             carouselTrack.innerHTML = ''; currentSlide = 0;
             // Utilise mediaMap pour trouver les bons médias
            const mediaUrls = (product.mediaMap && product.mediaMap[varietyToHighlight]) 
                              ? product.mediaMap[varietyToHighlight] 
                              : product.images; // Fallback
             
             if (!mediaUrls || mediaUrls.length === 0) { carouselTrack.innerHTML = '<div class="carousel-item"><img src="https://placehold.co/600x600/1a1a2e/ffffff?text=Image+Indisponible" alt="Média indisponible"></div>'; return; }
             
             mediaUrls.forEach((url) => {
                 const mediaElement = document.createElement('div'); 
                 mediaElement.className = 'carousel-item'; 
                 mediaElement.setAttribute('data-variety', varietyToHighlight); // Important pour la logique inversée
                 let content = url.toLowerCase().includes('.mp4') ? `<video autoplay controls playsinline loop muted class="w-full h-full"><source src="${url}" type="video/mp4">Vidéo non supportée.</video>` : `<img src="${url}" alt="${product.name}" class="w-full h-full" onerror="this.src='https://placehold.co/600x400/2a2a47/fff?text=Img'; this.onerror=null;">`;
                 mediaElement.innerHTML = content; 
                 carouselTrack.appendChild(mediaElement);
             });
             updateCarousel();
        }
        
        // --- FONCTION CORRIGÉE ---
        window.selectVariety = function(variety, event) {
             document.querySelectorAll('.variety-btn').forEach(b => b.classList.remove('active')); 
             
             if (event) { // Clic sur un bouton
                 event.currentTarget.classList.add('active'); 
             } else { // Appel depuis le carrousel
                 const targetBtn = document.querySelector(`#product-options .variety-btn[data-value="${variety}"]`); 
                 if(targetBtn) targetBtn.classList.add('active'); 
             }
             
             selectedVariety = variety; 
             
             // Ne met à jour le carrousel que si c'est un clic (pour éviter boucle infinie)
             if (event && currentProduct.mediaMap) {
                 updateProductCarousel(currentProduct, variety);
             }
        };

        function showProduct(productId) {
            currentProduct = products[productId]; if (!currentProduct) return;
            if (productName) productName.textContent = currentProduct.name; 
            if (productCategoryTitle) productCategoryTitle.textContent = currentProduct.category.toUpperCase();
            selectedVariety = currentProduct.varieties.length > 0 ? currentProduct.varieties[0] : null;
            
            let varietyHTML = ''; 
            // Ne pas afficher la section variété si une seule variété (qui est le nom du produit)
            const showVarieties = !(currentProduct.varieties.length === 1 && currentProduct.varieties[0] === currentProduct.name);
            
            if (currentProduct.varieties && currentProduct.varieties.length > 0 && showVarieties) { 
                varietyHTML = `<div class="mb-6"><h3 class="text-xl font-bold mb-3">Variété:</h3><div class="flex flex-wrap gap-2" id="variety-options">${currentProduct.varieties.map(v => `<button data-value="${v}" class="px-4 py-1.5 rounded-full border hover:bg-gray-700 transition-colors text-xs variety-btn" onclick="selectVariety('${v}', event)">${v}</button>`).join('')}</div></div>`; 
            }
            
            let weightHTML = ''; 
            if (currentProduct.prices) { 
                weightHTML = `<div><h3 class="text-xl font-bold mb-3">Poids et Prix:</h3><div class="flex flex-wrap gap-3" id="weight-options">${Object.keys(currentProduct.prices).map(w => `<button data-weight="${w}" class="weight-button" onclick="selectWeight('${w}')"><span class="weight-text">${w}</span><span class="price-text">${currentProduct.prices[w]}€</span></button>`).join('')}</div></div>`; 
            }
            
            if (productOptions) productOptions.innerHTML = varietyHTML + weightHTML;
            
            const firstVarietyBtn = document.querySelector('#variety-options .variety-btn');
            if(firstVarietyBtn && selectedVariety){
                 firstVarietyBtn.classList.add('active');
            }
            
            const firstWeightBtn = document.querySelector('#weight-options .weight-button'); 
            if (firstWeightBtn) { 
                firstWeightBtn.classList.add('active'); 
                selectedWeight = firstWeightBtn.dataset.weight; 
            }
            
            updateProductCarousel(currentProduct, selectedVariety); 
            mainApp?.classList.add('hidden'); 
            productPage?.classList.remove('hidden'); 
            window.scrollTo(0, 0);
        }

        window.selectWeight = function(weight) { selectedWeight = weight; document.querySelectorAll('.weight-button').forEach(btn => btn.classList.remove('active')); document.querySelector(`[data-weight="${weight}"]`).classList.add('active'); };

        // --- Navigation et Panier ---
        window.showHome = function() { closeCartPage(); pauseAllVideos(); productPage?.classList.add('hidden'); mainApp?.classList.remove('hidden'); currentFilter = null; document.getElementById('weed-pill')?.classList.remove('active'); document.getElementById('hash-pill')?.classList.remove('active'); initProductGrid(); }
        window.hideProduct = function() { pauseAllVideos(); productPage?.classList.add('hidden'); mainApp?.classList.remove('hidden'); }
        window.openCartPage = function() { pauseAllVideos(); cartPage?.classList.add('open'); mainApp?.classList.add('hidden'); productPage?.classList.add('hidden'); updateCartPage(); }
        window.closeCartPage = function() { cartPage?.classList.remove('open'); mainApp?.classList.remove('hidden'); }
        function updateCartPage() {
            const cartItemsContainer = document.getElementById('cart-items-page'); if (!cartItemsContainer) return; cartItemsContainer.innerHTML = ''; let total = 0; const items = Object.values(cartItems);
            if (items.length === 0) { cartItemsContainer.innerHTML = '<p class="text-center text-gray-400 py-10">Votre panier est vide.</p>'; document.getElementById('cart-total-page').textContent = `0€`; return; }
            items.forEach(item => { 
                const itemTotal = item.price * item.quantity; total += itemTotal;
                const itemElement = document.createElement('div'); itemElement.className = 'cart-page-item';
                const product = products[item.id.split('-')[0]]; let imageUrl = product && product.images.length > 0 ? product.images[0] : 'https://placehold.co/100/1e293b/fff?text=Img';
                itemElement.innerHTML = `<div class="w-16 h-16 rounded-lg overflow-hidden mr-4 flex-shrink-0"><img src="${imageUrl}" alt="${item.name}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100/2a2a47/fff?text=Img'; this.onerror=null;"></div><div class="flex-1 min-w-0"><h4 class="font-semibold truncate">${item.name}</h4><p class="text-sm text-gray-400 truncate">${item.weight} - ${item.variety}</p><p class="text-sm text-gray-400">Quantité: ${item.quantity}</p></div><div class="text-right ml-4 flex-shrink-0"><p class="font-bold">${itemTotal}€</p><button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-400 transition-colors text-xs mt-1 active:scale-90"><i class="fas fa-trash-alt mr-1"></i>Supprimer</button></div>`;
                cartItemsContainer.appendChild(itemElement);
             }); 
             const totalPageEl = document.getElementById('cart-total-page');
             if (totalPageEl) totalPageEl.textContent = `${total}€`;
        }
        
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', () => {
                 if (!selectedVariety || !selectedWeight) { showMessage("Veuillez sélectionner une variété et un poids."); return; }
                 const itemId = `${currentProduct.id}-${selectedWeight}-${selectedVariety}`;
                 if (cartItems[itemId]) cartItems[itemId].quantity++; else cartItems[itemId] = { id: itemId, name: currentProduct.name, variety: selectedVariety, weight: selectedWeight, price: currentProduct.prices[selectedWeight], quantity: 1 };
                 saveCart(); showMessage(`"${selectedVariety} (${selectedWeight})" ajouté au panier !`);
             });
        }
        
        if (buyNowBtn) {
            buyNowBtn.addEventListener('click', () => {
                 if (!selectedVariety || !selectedWeight) { showMessage("Veuillez sélectionner une variété et un poids."); return; }
                 const totalItemPrice = currentProduct.prices[selectedWeight];
                 let message = `Bonjour, je souhaite commander :\n- ${currentProduct.name}\n- Variété: ${selectedVariety}\n- Poids: ${selectedWeight}\n- Quantité: 1\n- Prix total: ${totalItemPrice}€`;
                 window.location.href = `https://t.me/Dailyhash?text=${encodeURIComponent(message)}`;
             });
        }
        
        window.removeFromCart = (itemId) => { delete cartItems[itemId]; saveCart(); updateCartPage(); };
        window.clearCart = () => { if(confirm("Vider le panier ?")) { cartItems = {}; saveCart(); updateCartPage(); } };
        window.placeOrder = () => {
             const items = Object.values(cartItems); if (items.length === 0) { showMessage("Votre panier est vide."); return; }
             let itemsString = ""; let total = 0;
             items.forEach((item, i) => { const itemTotal = item.price * item.quantity; itemsString += `[${item.name} (${item.variety}, ${item.weight}) x ${item.quantity} -> ${itemTotal}€]${i < items.length - 1 ? " | " : ""}`; total += itemTotal; });
             const fullMessage = `Salut, je voudrais passer une commande : ${itemsString} | Total de la commande : ${total}€ | Merci !`;
             window.location.href = `https://t.me/Dailyhash?text=${encodeURIComponent(fullMessage)}`;
             cartItems = {}; saveCart(); updateCartPage(); 
         };

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
             if (productGrid) initProductGrid();
             if (heroCarouselTrack && heroCarouselDots) {
                 updateHeroCarousel();
                 startHeroCarousel();
             }
             if (cartCounter) updateCartCounter();
         });

        window.showProduct = showProduct; window.hideProduct = hideProduct; window.openCartPage = openCartPage; window.closeCartPage = closeCartPage; window.closeModal = closeModal; window.selectWeight = selectWeight;
    </script>
</body>
</html>
  
